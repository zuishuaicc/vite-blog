import{_ as s,o as a,c as n,Q as l}from"./chunks/framework.b85f4cea.js";const p="/assets/image.a05ff81a.png",o="/assets/image-1.9766e2e7.png",E=JSON.parse('{"title":"Rust 动态连接库开发","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"views/application/rust/rust-lib.md","filePath":"views/application/rust/rust-lib.md","lastUpdated":1732641590000}'),e={name:"views/application/rust/rust-lib.md"},t=l('<h1 id="rust-动态连接库开发" tabindex="-1">Rust 动态连接库开发 <a class="header-anchor" href="#rust-动态连接库开发" aria-label="Permalink to &quot;Rust 动态连接库开发&quot;">​</a></h1><h3 id="一、环境要求" tabindex="-1">一、环境要求 <a class="header-anchor" href="#一、环境要求" aria-label="Permalink to &quot;一、环境要求&quot;">​</a></h3><ol><li>具备 nodejs 环境</li><li>具备 rust 编译环境</li></ol><h2 id="二、编写-rust-动态连接库" tabindex="-1">二、编写 rust 动态连接库 <a class="header-anchor" href="#二、编写-rust-动态连接库" aria-label="Permalink to &quot;二、编写 rust 动态连接库&quot;">​</a></h2><h3 id="_1-创建-lib-类型-rust-工程" tabindex="-1">1. 创建 lib 类型 rust 工程 <a class="header-anchor" href="#_1-创建-lib-类型-rust-工程" aria-label="Permalink to &quot;1. 创建 lib 类型 rust 工程&quot;">​</a></h3><p>使用 cargo 直接生成 lib 类型的工程</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code-dark"><code><span class="line"><span style="color:#FFCB6B;">cargo</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">new</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">rslib</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">--lib</span></span></code></pre><pre class="shiki material-theme-palenight vp-code-light"><code><span class="line"><span style="color:#FFCB6B;">cargo</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">new</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">rslib</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">--lib</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>目录结构 <img src="'+p+`" alt="alt text"></p><h3 id="_2-修改cargo-toml文件内容" tabindex="-1">2. 修改<code>Cargo.toml</code>文件内容 <a class="header-anchor" href="#_2-修改cargo-toml文件内容" aria-label="Permalink to &quot;2. 修改\`Cargo.toml\`文件内容&quot;">​</a></h3><div class="language-diff vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-theme-palenight vp-code-dark"><code><span class="line"><span style="color:#BABED8;">[package]</span></span>
<span class="line"><span style="color:#BABED8;">name = &quot;rslib&quot;</span></span>
<span class="line"><span style="color:#BABED8;">version = &quot;0.1.0&quot;</span></span>
<span class="line"><span style="color:#BABED8;">edition = &quot;2021&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">[lib]</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">crate-type = [&#39;cdylib&#39;]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">[dependencies]</span></span></code></pre><pre class="shiki material-theme-palenight vp-code-light"><code><span class="line"><span style="color:#BABED8;">[package]</span></span>
<span class="line"><span style="color:#BABED8;">name = &quot;rslib&quot;</span></span>
<span class="line"><span style="color:#BABED8;">version = &quot;0.1.0&quot;</span></span>
<span class="line"><span style="color:#BABED8;">edition = &quot;2021&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">[lib]</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">crate-type = [&#39;cdylib&#39;]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8;">[dependencies]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>若还有其他需要的 dependencies 可以在<code>[dependencies]</code>层级下直接写<code>依赖名=“版本号”</code><br> 也可以使用 cargo 提供的安装命令安装：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code-dark"><code><span class="line"><span style="color:#FFCB6B;">cargo</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">install</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">依赖名</span></span></code></pre><pre class="shiki material-theme-palenight vp-code-light"><code><span class="line"><span style="color:#FFCB6B;">cargo</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">install</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">依赖名</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_3-在lib-rs文件中写入具体实现方法" tabindex="-1">3. 在<code>lib.rs</code>文件中写入具体实现方法 <a class="header-anchor" href="#_3-在lib-rs文件中写入具体实现方法" aria-label="Permalink to &quot;3. 在\`lib.rs\`文件中写入具体实现方法&quot;">​</a></h3><div class="language-rust vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">rust</span><pre class="shiki material-theme-palenight vp-code-dark"><code><span class="line"><span style="color:#89DDFF;">#[</span><span style="color:#BABED8;">no_mangle</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">extern</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">C</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">left</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> right</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    left </span><span style="color:#89DDFF;">+</span><span style="color:#BABED8;"> right</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><pre class="shiki material-theme-palenight vp-code-light"><code><span class="line"><span style="color:#89DDFF;">#[</span><span style="color:#BABED8;">no_mangle</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#F78C6C;">pub</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">extern</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">C</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">fn</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">add</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;">left</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> right</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">-&gt;</span><span style="color:#BABED8;"> </span><span style="color:#FFCB6B;">i32</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">    left </span><span style="color:#89DDFF;">+</span><span style="color:#BABED8;"> right</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>1️⃣. 使用<code>#[no_mangle]</code>来组织 rust 对函数名进行编译，方便在 node 中以相同的方法名调用 2️⃣. 使用 pub extern &quot;c&quot; 来修饰函数，定义为使用 c 语言规范接口类型 3️⃣. 函数最后返回<code>left+right</code>的计算结果</p><h3 id="_4-编译为动态链接库" tabindex="-1">4.编译为动态链接库 <a class="header-anchor" href="#_4-编译为动态链接库" aria-label="Permalink to &quot;4.编译为动态链接库&quot;">​</a></h3><p>使用 cargo 提供的命令编译为动态连接库，可以加上--release 参数，优化打包的产物</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code-dark"><code><span class="line"><span style="color:#FFCB6B;">cargo</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">build</span></span></code></pre><pre class="shiki material-theme-palenight vp-code-light"><code><span class="line"><span style="color:#FFCB6B;">cargo</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">build</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>编译完成后，最终动态连接库文件路径：<br> debug 模式：target/debug/lib**.<code>[dll/os/dylib]</code><br> release 模式：target/release/lib**.<code>[dll/os/dylib]</code><br><strong>注：windows 中后缀为 dll,linux 中后缀为 os,macos 后缀为 dylib</strong>，**为创建动态链接库是定义的名字</p><h2 id="二-编写-node-工程调用" tabindex="-1">二. 编写 node 工程调用 <a class="header-anchor" href="#二-编写-node-工程调用" aria-label="Permalink to &quot;二. 编写 node 工程调用&quot;">​</a></h2><h3 id="_1-创建-node-工程" tabindex="-1">1. 创建 node 工程 <a class="header-anchor" href="#_1-创建-node-工程" aria-label="Permalink to &quot;1. 创建 node 工程&quot;">​</a></h3><p>使用 npm 快速创建 package.json</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code-dark"><code><span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">init</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">-y</span></span></code></pre><pre class="shiki material-theme-palenight vp-code-light"><code><span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">init</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">-y</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>创建完成后，修改<code>package.json</code>,使用 esmodule</p><div class="language-diff vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki material-theme-palenight vp-code-dark"><code><span class="line"><span style="color:#BABED8;">{</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;name&quot;: &quot;invode-rslib&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;version&quot;: &quot;1.0.0&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;description&quot;: &quot;&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;main&quot;: &quot;index.js&quot;,</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">  &quot;type&quot;: &quot;module&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;scripts&quot;: {</span></span>
<span class="line"><span style="color:#BABED8;">    &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;</span></span>
<span class="line"><span style="color:#BABED8;">  },</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;author&quot;: &quot;&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;license&quot;: &quot;ISC&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;dependencies&quot;: {</span></span>
<span class="line"><span style="color:#BABED8;">    &quot;ffi-rs&quot;: &quot;^1.0.63&quot;</span></span>
<span class="line"><span style="color:#BABED8;">  },</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;devDependencies&quot;: {</span></span>
<span class="line"><span style="color:#BABED8;">    &quot;@types/node&quot;: &quot;^20.12.7&quot;</span></span>
<span class="line"><span style="color:#BABED8;">  }</span></span>
<span class="line"><span style="color:#BABED8;">}</span></span></code></pre><pre class="shiki material-theme-palenight vp-code-light"><code><span class="line"><span style="color:#BABED8;">{</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;name&quot;: &quot;invode-rslib&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;version&quot;: &quot;1.0.0&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;description&quot;: &quot;&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;main&quot;: &quot;index.js&quot;,</span></span>
<span class="line"><span style="color:#89DDFF;">+</span><span style="color:#C3E88D;">  &quot;type&quot;: &quot;module&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;scripts&quot;: {</span></span>
<span class="line"><span style="color:#BABED8;">    &quot;test&quot;: &quot;echo \\&quot;Error: no test specified\\&quot; &amp;&amp; exit 1&quot;</span></span>
<span class="line"><span style="color:#BABED8;">  },</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;author&quot;: &quot;&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;license&quot;: &quot;ISC&quot;,</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;dependencies&quot;: {</span></span>
<span class="line"><span style="color:#BABED8;">    &quot;ffi-rs&quot;: &quot;^1.0.63&quot;</span></span>
<span class="line"><span style="color:#BABED8;">  },</span></span>
<span class="line"><span style="color:#BABED8;">  &quot;devDependencies&quot;: {</span></span>
<span class="line"><span style="color:#BABED8;">    &quot;@types/node&quot;: &quot;^20.12.7&quot;</span></span>
<span class="line"><span style="color:#BABED8;">  }</span></span>
<span class="line"><span style="color:#BABED8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="_2-安装-ffi-rs-依赖" tabindex="-1">2.安装 ffi-rs 依赖 <a class="header-anchor" href="#_2-安装-ffi-rs-依赖" aria-label="Permalink to &quot;2.安装 ffi-rs 依赖&quot;">​</a></h3><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight vp-code-dark"><code><span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">install</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">ffi-rs</span></span></code></pre><pre class="shiki material-theme-palenight vp-code-light"><code><span class="line"><span style="color:#FFCB6B;">npm</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">install</span><span style="color:#BABED8;"> </span><span style="color:#C3E88D;">ffi-rs</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><h3 id="_3-放入动态链接库文件" tabindex="-1">3.放入动态链接库文件 <a class="header-anchor" href="#_3-放入动态链接库文件" aria-label="Permalink to &quot;3.放入动态链接库文件&quot;">​</a></h3><p>将前面生成的 ib**.<code>[dll/os/dylib]</code>文件复制过来，放到根目录下 <img src="`+o+`" alt="alt text"></p><h3 id="_4-使用-ffi-rs-调用动态连接库" tabindex="-1">4.使用 ffi-rs 调用动态连接库 <a class="header-anchor" href="#_4-使用-ffi-rs-调用动态连接库" aria-label="Permalink to &quot;4.使用 ffi-rs 调用动态连接库&quot;">​</a></h3><p>创建 index.js 文件，写入如下内容：</p><div class="language-js vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki material-theme-palenight vp-code-dark"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">platform</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">node:os</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">equal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">node:assert</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">load</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">DataType</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">open</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">close</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ffi-rs</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">22</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> b </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">100</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> dynamicLib </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#82AAFF;">platform</span><span style="color:#BABED8;">() </span><span style="color:#89DDFF;">===</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">win32</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">?</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./librslib.dll</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">platform</span><span style="color:#BABED8;">() </span><span style="color:#89DDFF;">===</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">darwin</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">?</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./librslib.dylib</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./librslib.so</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 首先你需要调用 open 来打开一个动态链接库并指定一个key来作为标志符在后续操作里调用</span></span>
<span class="line"><span style="color:#82AAFF;">open</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">library</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">rslib</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// key</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> dynamicLib</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// path</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">load</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">library</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">rslib</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// path to the dynamic library file</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">funcName</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">add</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// the name of the function to call</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">retType</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> DataType</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">I32</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// the return value type</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">paramsType</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [DataType</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">I32</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> DataType</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">I32]</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// the parameter types</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">paramsValue</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [a</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> b]</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// the actual parameter values</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#82AAFF;">equal</span><span style="color:#BABED8;">(r</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> a </span><span style="color:#89DDFF;">+</span><span style="color:#BABED8;"> b)</span></span>
<span class="line"><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#BABED8;">(r)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 当你不需要再用到这个动态链接库时，使用close来释放它</span></span>
<span class="line"><span style="color:#82AAFF;">close</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">rslib</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span></span></code></pre><pre class="shiki material-theme-palenight vp-code-light"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">platform</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">node:os</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">equal</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">node:assert</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">load</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">DataType</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">open</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">close</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ffi-rs</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">22</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> b </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#F78C6C;">100</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> dynamicLib </span><span style="color:#89DDFF;">=</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#82AAFF;">platform</span><span style="color:#BABED8;">() </span><span style="color:#89DDFF;">===</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">win32</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">?</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./librslib.dll</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">platform</span><span style="color:#BABED8;">() </span><span style="color:#89DDFF;">===</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">darwin</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">?</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./librslib.dylib</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">./librslib.so</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 首先你需要调用 open 来打开一个动态链接库并指定一个key来作为标志符在后续操作里调用</span></span>
<span class="line"><span style="color:#82AAFF;">open</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">library</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">rslib</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// key</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">path</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> dynamicLib</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// path</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> r </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">load</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">library</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">rslib</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// path to the dynamic library file</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">funcName</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">add</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// the name of the function to call</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">retType</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> DataType</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">I32</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// the return value type</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">paramsType</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [DataType</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">I32</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> DataType</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">I32]</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// the parameter types</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#F07178;">paramsValue</span><span style="color:#89DDFF;">:</span><span style="color:#BABED8;"> [a</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> b]</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#676E95;font-style:italic;">// the actual parameter values</span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#82AAFF;">equal</span><span style="color:#BABED8;">(r</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> a </span><span style="color:#89DDFF;">+</span><span style="color:#BABED8;"> b)</span></span>
<span class="line"><span style="color:#BABED8;">console</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">log</span><span style="color:#BABED8;">(r)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 当你不需要再用到这个动态链接库时，使用close来释放它</span></span>
<span class="line"><span style="color:#82AAFF;">close</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">rslib</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><code>r</code>即为调用动态链接库的计算结果，<code>equal</code>为校验结果 r 与 a+b 是否相同的方法</p><h3 id="_5-官方示例地址" tabindex="-1">5.官方示例地址 <a class="header-anchor" href="#_5-官方示例地址" aria-label="Permalink to &quot;5.官方示例地址&quot;">​</a></h3><p><a href="https://github.com/alexcrichton/rust-ffi-examples/blob/master/node-to-rust/src/lib.rs" target="_blank" rel="noreferrer">https://github.com/alexcrichton/rust-ffi-examples/blob/master/node-to-rust/src/lib.rs</a></p><h1 id="使用-napi-rs-开发-rust-动态链接库" tabindex="-1">使用 napi-rs 开发 Rust 动态链接库 <a class="header-anchor" href="#使用-napi-rs-开发-rust-动态链接库" aria-label="Permalink to &quot;使用 napi-rs 开发 Rust 动态链接库&quot;">​</a></h1><p>文档地址<a href="https://github.com/napi-rs/napi-rs" target="_blank" rel="noreferrer">https://github.com/napi-rs/napi-rs</a></p><h1 id="使用-napi-rs-开发的-node-rs-项目下完成的-node-插件包" tabindex="-1">使用 napi-rs 开发的 node-rs 项目下完成的.node 插件包 <a class="header-anchor" href="#使用-napi-rs-开发的-node-rs-项目下完成的-node-插件包" aria-label="Permalink to &quot;使用 napi-rs 开发的 node-rs 项目下完成的.node 插件包&quot;">​</a></h1><p><a href="https://github.com/napi-rs/node-rs" target="_blank" rel="noreferrer">https://github.com/napi-rs/node-rs</a></p>`,39),r=[t];function c(i,y,D,B,F,u){return a(),n("div",null,r)}const b=s(e,[["render",c]]);export{E as __pageData,b as default};
